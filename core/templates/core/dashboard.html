{% extends 'core/base.html' %}
{% load currency_filters %}

{% block title %}Dashboard Financeiro{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% load static %}
<link rel="stylesheet" href="{% static 'css/dist/styles.css' %}">
<style>
  body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .glass-panel {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 16px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    @supports not (backdrop-filter: blur(12px)) {
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
        }
    }
    
    .valor-positivo {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    .valor-negativo {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    .dark .valor-positivo {
        background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
    }
    
    .dark .valor-negativo {
        background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    }

    .stats-card {
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }
    
    .table-row {
        transition: all 0.2s ease;
    }
    
    .table-row:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
    }
    
    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
    }
    .dark .card-title {
        color: #e5e7eb;
    }

    .card-value {
        font-size: 2.25rem;
        font-weight: 800;
        margin-top: 0.5rem;
    }

    .chart-container {
        height: 300px;
        min-height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .glass-panel:nth-child(6) {
        border-left: 4px solid #10b981;
    }

    .chart-container canvas {
        transition: opacity 0.3s ease;
    }

    .input-group {
        margin-bottom: 1rem;
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .hidden {
        display: none;
    }

    .filter-tag-sm {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .filter-tag-sm button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        margin-left: 0.25rem;
        font-size: 0.7rem;
    }

    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .chart-customization-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    
    .chart-toggle-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        background: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .chart-toggle-card:hover {
        background: #f5f3ff;
        border-color: #a78bfa;
    }
    
    .chart-toggle-card.selected {
        border-color: #6366f1;
        background: #eef2ff;
    }
</style>
{% endblock %}

{% block content %}

<!-- Elemento hidden para passar dados do contexto para JavaScript -->
{{ dados_graficos_json|json_script:"dados-json" }}

<div class="glass-panel min-h-screen p-8 flex flex-col space-y-6">

    <!-- Cabeçalho -->
    <div class="glass-panel p-6 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-2">
                    <i class="fas fa-chart-line mr-3 text-indigo-600"></i>
                    Dashboard Financeiro
                </h1>
                <p class="text-xl text-gray-600 dark:text-gray-300 font-semibold">
                    Visão geral e detalhada das suas finanças
                </p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="exportReportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-all">
                    <i class="fas fa-download mr-2"></i>
                    Exportar Relatório
                </button>
            </div>
        </div>
    </div>

    <!-- BARRA DE FILTROS SUPERIOR -->
    <div class="glass-panel p-4 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <button id="toggleFiltersBar" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center transition-all">
                    <i class="fas fa-sliders-h mr-2"></i>
                    Filtros e Gráficos
                </button>
                
                <!-- Resumo dos Filtros Ativos -->
                <div id="activeFiltersSummary" class="flex-1">
                    <div id="filtersList" class="flex flex-wrap gap-2">
                        <span class="text-gray-500 text-sm">Nenhum filtro aplicado</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="applyFiltersBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-all">
                    <i class="fas fa-check mr-2"></i>
                    Aplicar
                </button>
                <button id="resetFiltersBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center transition-all">
                    <i class="fas fa-undo mr-2"></i>
                    Limpar
                </button>
            </div>
        </div>

        <!-- Painel de Filtros Expandível -->
        <div id="filtersPanel" class="mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Filtro Período -->
                <div>
                    <label class="form-label">Período</label>
                    <select id="filterPeriodo" class="form-input">
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="180">Últimos 6 meses</option>
                        <option value="365">Último ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>

                <!-- Filtro Tipo Transação -->
                <div>
                    <label class="form-label">Tipo de Transação</label>
                    <select id="filterTipoTransacao" class="form-input">
                        <option value="todos">Todos</option>
                        <option value="entradas">Entradas</option>
                        <option value="saidas">Saídas</option>
                    </select>
                </div>

                <!-- Filtro Conta Bancária -->
                <div>
                    <label class="form-label">Conta Bancária</label>
                    <select id="filterConta" class="form-input">
                        <option value="todas">Todas</option>
                        {% for conta in contas_bancarias %}
                        <option value="{{ conta.id }}">{{ conta }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtro Categoria -->
                <div>
                    <label class="form-label">Categoria</label>
                    <select id="filterCategoria" class="form-input">
                        <option value="todas">Todas</option>
                        {% for code, label in categorias_choices %}
                        <option value="{{ code }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Campos de Data Personalizada -->
            <div id="customDateFields" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
                <div>
                    <label class="form-label">Data Inicial</label>
                    <input type="date" id="filterDataInicial" class="form-input">
                </div>
                <div>
                    <label class="form-label">Data Final</label>
                    <input type="date" id="filterDataFinal" class="form-input">
                </div>
            </div>

            <!-- Seletor de Gráficos -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold mb-3 dark:text-white flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-indigo-500"></i>
                    Gráficos Visíveis
                </h3>
                <div class="chart-customization-grid">
                    <!-- Gráficos principais -->
                    <div class="chart-toggle-card selected" data-chart="transacoesMensaisChart">
                        <span>Receitas vs Despesas Mensais</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="saldoAcumuladoChart">
                        <span>Saldo Acumulado</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="sazonalidadeChart">
                        <span>Análise de Sazonalidade</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="projecaoSaldoChart">
                        <span>Projeção Futura de Saldo</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="saidasCategoriaChart">
                        <span>Despesas por Categoria</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="entradasCategoriaChart">
                        <span>Receitas por Categoria</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="saldoContasChart">
                        <span>Saldos por Conta Bancária</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="despesasFixasVariaveisChart">
                        <span>Despesas Fixas vs Variáveis</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="statusPagamentosChart">
                        <span>Status de Pagamentos</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="alocacaoInvestimentosChart">
                        <span>Sugestão de Alocação de Investimentos</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    
                    <!-- Novos gráficos adicionados -->
                    <div class="chart-toggle-card selected" data-chart="reservaEmergenciaSection">
                        <span>Reserva de Emergência</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="indicadoresSaudeSection">
                        <span>Indicadores de Saúde Financeira</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="analiseComportamentalSection">
                        <span>Análise Comportamental</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="simulacoesCenariosSection">
                        <span>Simulações de Cenários</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="chart-toggle-card selected" data-chart="analiseRiscosSection">
                        <span>Análise de Riscos</span>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden glass-panel p-12 mb-8 text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-lg text-gray-600 dark:text-gray-300">Carregando dados...</p>
    </div>

    <!-- Cards Principais -->
    <div id="mainCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 stats-grid">
        <!-- Saldo Geral -->
        <div class="glass-panel p-6 stats-card border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <span class="card-title text-gray-800 dark:text-gray-200">Saldo Geral</span>
                <i class="fas fa-balance-scale text-3xl text-blue-500"></i>
            </div>
            <p id="saldoGeral" class="card-value text-blue-600">R$ 0,00</p>
            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400 flex items-center">
                <i class="fas fa-info-circle mr-1"></i>
                <span>Visão consolidada das suas finanças</span>
            </div>
        </div>

        <!-- Receitas do Período -->
        <div class="glass-panel p-6 stats-card border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <span class="card-title text-gray-800 dark:text-gray-200">Receitas do Período</span>
                <i class="fas fa-arrow-up text-3xl text-green-500"></i>
            </div>
            <p id="entradasMes" class="card-value text-green-600">R$ 0,00</p>
            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400 flex items-center">
                <span id="variacaoReceitas" class="font-medium mr-1">+0%</span> vs período anterior
            </div>
        </div>

        <!-- Despesas do Período -->
        <div class="glass-panel p-6 stats-card border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <span class="card-title text-gray-800 dark:text-gray-200">Despesas do Período</span>
                <i class="fas fa-arrow-down text-3xl text-red-500"></i>
            </div>
            <p id="saidasMes" class="card-value text-red-600">R$ 0,00</p>
            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400 flex items-center">
                <span id="variacaoDespesas" class="font-medium mr-1">+0%</span> vs período anterior
            </div>
        </div>

        <!-- Reserva de Emergência -->
        <div class="glass-panel p-6 stats-card border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <span class="card-title text-gray-800 dark:text-gray-200">Reserva de Emergência</span>
                <i class="fas fa-shield-alt text-3xl text-purple-500"></i>
            </div>
            <p id="saldoPoupancas" class="card-value text-purple-600">R$ 0,00</p>
            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400 flex items-center">
                <i class="fas fa-target mr-1"></i>
                <span id="metaReserva" class="ml-1">Meta: 6 meses (R$ 0,00)</span>
            </div>
        </div>
    </div>

    <!-- Gráficos Principais -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Receitas vs Despesas Mensais -->
        <div id="transacoesMensaisChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-blue-500"></i>
                Receitas vs Despesas Mensais
            </h2>
            <div class="chart-container">
                <canvas id="transacoesMensaisCanvas"></canvas>
            </div>
        </div>

        <!-- Saldo Acumulado -->
        <div id="saldoAcumuladoChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-area mr-2 text-indigo-500"></i>
                Saldo Acumulado
            </h2>
            <div class="chart-container">
                <canvas id="saldoAcumuladoCanvas"></canvas>
            </div>
        </div>
        
        <!-- Sazonalidade -->
        <div id="sazonalidadeChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-wave-square mr-2 text-purple-500"></i>
                Análise de Sazonalidade
            </h2>
            <div class="chart-container">
                <canvas id="sazonalidadeCanvas"></canvas>
            </div>
        </div>

        <!-- Projeção Futura -->
        <div id="projecaoSaldoChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-rocket mr-2 text-pink-500"></i>
                Projeção Futura de Saldo
            </h2>
            <div class="chart-container">
                <canvas id="projecaoSaldoCanvas"></canvas>
            </div>
        </div>

        <!-- Despesas por Categoria -->
        <div id="saidasCategoriaChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-tags mr-2 text-orange-500"></i>
                Despesas por Categoria
            </h2>
            <div class="chart-container">
                <canvas id="saidasCategoriaCanvas"></canvas>
            </div>
        </div>

        <!-- Receitas por Categoria -->
        <div id="entradasCategoriaChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-hand-holding-usd mr-2 text-teal-500"></i>
                Receitas por Categoria
            </h2>
            <div class="chart-container">
                <canvas id="entradasCategoriaCanvas"></canvas>
            </div>
            <div id="entradasCategoriaFallback" class="hidden text-center text-gray-500 dark:text-gray-400 mt-4">
                <i class="fas fa-chart-pie text-4xl mb-2"></i>
                <p>Nenhuma receita registrada neste período</p>
            </div>
        </div>

        <!-- Saldos por Conta Bancária -->
        <div id="saldoContasChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-university mr-2 text-blue-400"></i>
                Saldos por Conta Bancária
            </h2>
            <div class="chart-container">
                <canvas id="saldoContasCanvas"></canvas>
            </div>
        </div>

        <!-- Despesas Fixas vs Variáveis -->
        <div id="despesasFixasVariaveisChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-receipt mr-2 text-yellow-500"></i>
                Despesas Fixas vs Variáveis
            </h2>
            <div class="chart-container">
                <canvas id="despesasFixasVariaveisCanvas"></canvas>
            </div>
        </div>

        <!-- Status de Pagamentos -->
        <div id="statusPagamentosChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>
                Status de Pagamentos
            </h2>
            <div class="chart-container">
                <canvas id="statusPagamentosCanvas"></canvas>
            </div>
        </div>
        
        <!-- Alocação de Investimentos -->
        <div id="alocacaoInvestimentosChart" class="glass-panel p-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-pie mr-2 text-gray-500"></i>
                Sugestão de Alocação de Investimentos
            </h2>
            <div class="chart-container">
                <canvas id="alocacaoInvestimentosCanvas"></canvas>
            </div>
            <p id="sugestaoInvestimentos" class="mt-4 text-sm text-gray-600 italic text-center dark:text-gray-400">
                <strong>Sugestão:</strong> Foque em construir reserva de emergência primeiro.
            </p>
        </div>
    </div>

    <!-- Seção de Reserva de Emergência -->
    <div id="reservaEmergenciaSection" class="glass-panel p-6 mt-4 mb-8">
        <div class="flex items-center justify-between mb-4">
            <span class="card-title text-gray-800 dark:text-gray-200">Reserva de Emergência</span>
            <i class="fas fa-shield-alt text-3xl text-purple-500"></i>
        </div>
        
        <!-- Seletor de Meses da Meta -->
        <div class="mb-8 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg w-full md:w-2/4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="fas fa-sliders-h mr-1 text-purple-600"></i>Meses de despesa para meta:
            </label>
            <select id="meses-meta-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="3">3 meses</option>
                <option value="6" selected>6 meses</option>
                <option value="9">9 meses</option>
                <option value="12">12 meses</option>
            </select>
            <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                Quantos meses de despesa você quer como reserva?
            </div>
        </div>
        
        <!-- Meta Ideal -->
        <div class="mb-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium">Meta Ideal:</span>
                <span id="reservaEmergenciaIdeal" class="text-lg font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="text-xs text-gray-600 dark:text-gray-400">
                Média: <span id="despesaMensalMedia">R$ 0,00</span>/mês
            </div>
        </div>
        
        <!-- Saldo Atual em Poupanças -->
        <div class="mb-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Saldo em Poupanças:</span>
                <span id="saldoAtualPoupancas" class="text-lg font-bold">R$ 0,00</span>
            </div>
        </div>
        
        <!-- Diferença -->
        <div class="mb-3 p-3 rounded-lg" id="diferencaReservaPanel">
            <div class="flex justify-between items-center">
                <span id="diferencaLabel" class="text-sm font-medium">Falta:</span>
                <span id="valorFaltante" class="text-lg font-bold">R$ 0,00</span>
            </div>
        </div>
        
        <!-- Barra de Progresso -->
        <div class="mb-3">
            <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium dark:text-gray-300">Progresso:</span>
                <span id="percentualAtingido" class="text-sm font-bold">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                <div id="progressBar" class="h-2 rounded-full bg-blue-500" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Projeção de Tempo -->
        <div id="projecaoTempoPanel" class="mb-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
            <div class="text-center">
                <span class="text-sm font-medium dark:text-gray-300">
                    <i class="fas fa-clock mr-1 text-gray-600 dark:text-gray-400"></i>Previsão para atingir:
                </span>
                <div id="tempoProjecao" class="mt-1 text-md font-bold dark:text-white">N/A</div>
                <div class="text-xs text-gray-600 mt-1 dark:text-gray-400">
                    Baseado na sua poupança mensal estimada
                </div>
            </div>
        </div>
        
        <!-- Status -->
        <div id="statusReservaPanel" class="text-center p-2 rounded-lg">
            <i id="statusIcon" class="fas mr-1"></i>
            <span id="statusText" class="text-lg font-bold">0% conquistado</span>
        </div>
    </div>

    <!-- Indicadores de Saúde Financeira -->
    <div id="indicadoresSaudeSection" class="glass-panel p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
            <i class="fas fa-heartbeat mr-2 text-red-500"></i>
            Indicadores de Saúde Financeira
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Liquidez Corrente</h3>
                <p class="text-3xl font-bold text-blue-600" id="liquidezCorrente">0%</p>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Margem de Segurança</h3>
                <p class="text-3xl font-bold text-green-600" id="margemSeguranca">0%</p>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Endividamento</h3>
                <p class="text-3xl font-bold text-red-600" id="endividamento">0%</p>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Poupança Mensal Estimada</h3>
                <p class="text-3xl font-bold text-purple-600" id="poupancaMensal">R$ 0,00</p>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Reserva de Emergência Ideal</h3>
                <p class="text-3xl font-bold text-orange-600" id="reservaEmergenciaIdealIndicador">R$ 0,00</p>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Nível de Risco</h3>
                <p class="text-3xl font-bold text-yellow-600" id="nivelRisco">Baixo</p>
            </div>
        </div>
    </div>

    <!-- Análise Comportamental -->
    <div id="analiseComportamentalSection" class="glass-panel p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
            <i class="fas fa-brain mr-2 text-green-500"></i>
            Análise Comportamental
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-xl mb-2 dark:text-gray-200 flex items-center">
                    <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                    Gastos por Dia da Semana
                </h3>
                <div class="chart-container">
                    <canvas id="gastosPorDiaChart"></canvas>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-xl mb-2 dark:text-gray-200 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-purple-500"></i>
                    Gastos por Tipo (Comportamental)
                </h3>
                <div class="chart-container">
                    <canvas id="categoriasComportamentoChart"></canvas>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow-sm">
                <h3 class="font-semibold text-xl mb-2 dark:text-gray-200 flex items-center">
                    <i class="fas fa-clock mr-2 text-teal-500"></i>
                    Gastos por Hora do Dia
                </h3>
                <div class="chart-container">
                    <canvas id="gastosPorHoraChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Simulações de Cenários -->
    <div id="simulacoesCenariosSection" class="glass-panel p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
            <i class="fas fa-calculator mr-2 text-blue-600"></i>
            Simulações de Cenários
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg shadow">
                <h4 class="font-semibold dark:text-gray-200">Aumento de 10% nas Despesas:</h4>
                <p class="text-lg text-red-600 font-bold" id="aumentoDespesas">R$ 0,00</p>
            </div>
            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg shadow">
                <h4 class="font-semibold dark:text-gray-200">Redução de 10% nas Despesas:</h4>
                <p class="text-lg text-green-600 font-bold" id="reducaoDespesas">R$ 0,00</p>
            </div>
            <div class="p-4 bg-teal-50 dark:bg-teal-900/20 rounded-lg shadow">
                <h4 class="font-semibold dark:text-gray-200">Aumento de 10% nas Receitas:</h4>
                <p class="text-lg text-green-600 font-bold" id="aumentoReceitas">R$ 0,00</p>
            </div>
            <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg shadow">
                <h4 class="font-semibold dark:text-gray-200">Redução de 10% nas Receitas:</h4>
                <p class="text-lg text-red-600 font-bold" id="reducaoReceitas">R$ 0,00</p>
            </div>
            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg shadow">
                <h4 class="font-semibold dark:text-gray-200">Impacto da Inflação (5%):</h4>
                <p class="text-lg text-red-600 font-bold" id="impactoInflacao">R$ 0,00</p>
            </div>
        </div>
    </div>

    <!-- Análise de Riscos -->
    <div id="analiseRiscosSection" class="glass-panel p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
            <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>
            Análise de Riscos
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
            <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Concentração de Risco de Renda</h3>
                <p class="text-3xl font-bold text-red-600" id="concentracaoRisco">0%</p>
            </div>
            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg dark:text-gray-200">Reserva de Emergência Coberta</h3>
                <p class="text-3xl font-bold text-green-600" id="reservaIdealCoberta">R$ 0,00 / R$ 0,00</p>
            </div>
        </div>
        <p class="mt-4 text-sm text-gray-600 italic text-center dark:text-gray-400">
            O nível de risco da sua renda é <strong id="nivelRiscoTexto">Baixo</strong>.
        </p>
    </div>

    <!-- Últimas Transações -->
    <div class="glass-panel overflow-hidden">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                <i class="fas fa-history mr-3 text-indigo-600"></i>
                Últimas Transações
            </h2>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-indigo-50 dark:bg-indigo-900">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider dark:text-indigo-200">
                            Data
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider dark:text-indigo-200">
                            Descrição
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider dark:text-indigo-200">
                            Valor
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider dark:text-indigo-200">
                            Categoria
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider dark:text-indigo-200">
                            Conta
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="ultimasTransacoesTable">
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                            Nenhuma transação encontrada
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ================================================================
// FUNÇÕES GLOBAIS DE FORMATAÇÃO
// ================================================================

function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}

function formatPercent(value) {
    if (value === null || value === undefined || isNaN(value)) return '0%';
    return `${value.toFixed(1)}%`;
}

// ================================================================
// SISTEMA DE FILTROS E GRÁFICOS
// ================================================================

class DashboardFilters {
    constructor() {
        this.activeFilters = {};
        this.initializeElements();
        this.bindEvents();
        this.initializeDates();
        this.preencherFiltrosAtuais();
    }

    initializeElements() {
        this.activeFiltersSummary = document.getElementById('activeFiltersSummary');
        this.filtersList = document.getElementById('filtersList');
        this.applyFiltersBtn = document.getElementById('applyFiltersBtn');
        this.resetFiltersBtn = document.getElementById('resetFiltersBtn');
        this.filterPeriodo = document.getElementById('filterPeriodo');
        this.customDateFields = document.getElementById('customDateFields');
    }

    bindEvents() {
        if (this.applyFiltersBtn) {
            this.applyFiltersBtn.addEventListener('click', () => this.applyFilters());
        }
        if (this.resetFiltersBtn) {
            this.resetFiltersBtn.addEventListener('click', () => this.resetFilters());
        }
        if (this.filterPeriodo) {
            this.filterPeriodo.addEventListener('change', () => this.toggleCustomDateFields());
        }
    }

    initializeDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        if (!document.getElementById('filterDataFinal').value) {
            document.getElementById('filterDataFinal').value = today.toISOString().split('T')[0];
        }
        if (!document.getElementById('filterDataInicial').value) {
            document.getElementById('filterDataInicial').value = thirtyDaysAgo.toISOString().split('T')[0];
        }
    }

    toggleCustomDateFields() {
        if (this.filterPeriodo.value === 'custom') {
            this.customDateFields.classList.remove('hidden');
        } else {
            this.customDateFields.classList.add('hidden');
        }
    }

    collectFilters() {
        const filters = {
            periodo: document.getElementById('filterPeriodo').value,
            data_inicial: document.getElementById('filterDataInicial').value,
            data_final: document.getElementById('filterDataFinal').value,
            tipo_transacao: document.getElementById('filterTipoTransacao').value,
            conta: document.getElementById('filterConta').value,
            categoria: document.getElementById('filterCategoria').value
        };

        Object.keys(filters).forEach(key => {
            if (!filters[key] || filters[key] === 'todas' || filters[key] === 'todos') {
                delete filters[key];
            }
        });

        return filters;
    }

    updateActiveFiltersSummary(filters) {
        this.activeFilters = filters;
        
        if (Object.keys(filters).length === 0) {
            this.filtersList.innerHTML = '<span class="text-gray-500 text-sm">Nenhum filtro aplicado</span>';
            return;
        }

        this.filtersList.innerHTML = '';

        const filterLabels = {
            periodo: 'Período',
            data_inicial: 'Data Inicial',
            data_final: 'Data Final',
            tipo_transacao: 'Tipo',
            conta: 'Conta',
            categoria: 'Categoria'
        };

        const periodos = {
            '30': '30 dias',
            '90': '3 meses',
            '180': '6 meses',
            '365': '1 ano',
            'custom': 'Personalizado'
        };

        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                const filterTag = document.createElement('div');
                filterTag.className = 'filter-tag-sm';
                
                let value = filters[key];
                if (key === 'periodo') {
                    value = periodos[value] || value;
                }

                filterTag.innerHTML = `
                    ${filterLabels[key]}: ${value}
                    <button type="button" onclick="dashboardFilters.removeFilter('${key}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                this.filtersList.appendChild(filterTag);
            }
        });
    }

    removeFilter(filterKey) {
        const elementId = `filter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}`;
        const inputElement = document.getElementById(elementId);
        
        if (inputElement) {
            if (inputElement.type === 'select-one') {
                const defaultOption = inputElement.querySelector('option[value="todas"], option[value="todos"]');
                if (defaultOption) {
                    inputElement.value = defaultOption.value;
                } else {
                    inputElement.selectedIndex = 0;
                }
            } else {
                inputElement.value = '';
            }
        }
        this.applyFilters();
    }

    applyFilters() {
        this.showLoading(true);
        
        const filters = this.collectFilters();
        this.updateActiveFiltersSummary(filters);
        
        const params = new URLSearchParams();
        
        Object.keys(filters).forEach(key => {
            if (filters[key] && filters[key] !== '' && filters[key] !== 'todas' && filters[key] !== 'todos') {
                params.append(key, filters[key]);
            }
        });
        
        const mesesMetaSelect = document.getElementById('meses-meta-select');
        if (mesesMetaSelect && mesesMetaSelect.value !== '6') {
            params.append('meses_meta', mesesMetaSelect.value);
        }
        
        // Salvar preferências de gráficos
        this.saveChartPreferences();
        
        const url = `${window.location.pathname}?${params.toString()}`;
        
        if (this.applyFiltersBtn) {
            this.applyFiltersBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Aplicando...';
            this.applyFiltersBtn.disabled = true;
        }
        
        setTimeout(() => {
            window.location.href = url;
        }, 500);
    }

    resetFilters() {
        // Resetar selects
        document.querySelectorAll('#filtersPanel select').forEach(select => {
            const defaultOption = select.querySelector('option[value="todas"], option[value="todos"]');
            if (defaultOption) {
                select.value = defaultOption.value;
            } else {
                select.selectedIndex = 0;
            }
        });
        
        // Resetar datas
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('filterDataFinal').value = today.toISOString().split('T')[0];
        document.getElementById('filterDataInicial').value = thirtyDaysAgo.toISOString().split('T')[0];
        
        document.getElementById('filterPeriodo').value = '30';
        document.getElementById('customDateFields').classList.add('hidden');
        
        this.applyFilters();
    }

    preencherFiltrosAtuais() {
        const urlParams = new URLSearchParams(window.location.search);
        
        const filtros = [
            'periodo', 'tipo_transacao', 'conta', 'categoria', 'data_inicial', 'data_final'
        ];
        
        filtros.forEach(filtro => {
            const valor = urlParams.get(filtro);
            const elemento = document.getElementById(`filter${filtro.charAt(0).toUpperCase() + filtro.slice(1)}`);
            if (elemento && valor) {
                elemento.value = valor;
                
                if (filtro === 'periodo' && valor === 'custom') {
                    document.getElementById('customDateFields').classList.remove('hidden');
                }
            }
        });
        
        const mesesMeta = urlParams.get('meses_meta');
        const mesesMetaSelect = document.getElementById('meses-meta-select');
        if (mesesMetaSelect && mesesMeta) {
            mesesMetaSelect.value = mesesMeta;
        }
        
        // Atualizar resumo de filtros ativos
        const filters = this.collectFilters();
        this.updateActiveFiltersSummary(filters);
    }

    showLoading(show) {
        const loadingState = document.getElementById('loadingState');
        const mainCards = document.getElementById('mainCards');
        const chartsSection = document.getElementById('chartsSection');
        
        if (show) {
            if (loadingState) loadingState.classList.remove('hidden');
            if (mainCards) mainCards.classList.add('hidden');
            if (chartsSection) chartsSection.classList.add('hidden');
        } else {
            if (loadingState) loadingState.classList.add('hidden');
            if (mainCards) mainCards.classList.remove('hidden');
            if (chartsSection) chartsSection.classList.remove('hidden');
        }
    }

    // Sistema de gráficos
    saveChartPreferences() {
        const preferences = {};
        document.querySelectorAll(".chart-toggle-card").forEach(card => {
            const chartId = card.dataset.chart;
            preferences[chartId] = card.classList.contains("selected");
        });
        localStorage.setItem('chartPreferences', JSON.stringify(preferences));
    }

    loadChartPreferences() {
        const saved = localStorage.getItem('chartPreferences');
        if (saved) {
            const preferences = JSON.parse(saved);
            document.querySelectorAll(".chart-toggle-card").forEach(card => {
                const chartId = card.dataset.chart;
                const isSelected = preferences[chartId];
                const icon = card.querySelector("i");
                
                if (isSelected !== undefined) {
                    if (isSelected) {
                        card.classList.add("selected");
                        if (icon) icon.classList.remove("hidden");
                    } else {
                        card.classList.remove("selected");
                        if (icon) icon.classList.add("hidden");
                    }
                }
            });
            this.initializeChartVisibility();
        }
    }

    initializeChartVisibility() {
        document.querySelectorAll(".chart-toggle-card").forEach(card => {
            const chartId = card.dataset.chart;
            const chartElement = document.getElementById(chartId);
            
            if (chartElement) {
                if (card.classList.contains("selected")) {
                    chartElement.classList.remove("hidden");
                } else {
                    chartElement.classList.add("hidden");
                }
            }
        });
    }

    initializeChartToggles() {
        document.querySelectorAll(".chart-toggle-card").forEach(card => {
            card.addEventListener("click", () => {
                const chartId = card.dataset.chart;
                
                // Toggle do estado selecionado
                card.classList.toggle("selected");
                
                // Toggle do ícone de check
                const icon = card.querySelector("i");
                if (icon) {
                    icon.classList.toggle("hidden");
                }
                
                // LÓGICA INVERTIDA: se estiver selecionado, mostra o gráfico; se não, oculta
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    if (card.classList.contains("selected")) {
                        chartElement.classList.remove("hidden");
                    } else {
                        chartElement.classList.add("hidden");
                    }
                }
                
                // Salvar preferências
                this.saveChartPreferences();
            });
        });
    }
}

// ================================================================
// INICIALIZAÇÃO
// ================================================================

document.addEventListener("DOMContentLoaded", () => {
    // Inicializar sistema de filtros
    window.dashboardFilters = new DashboardFilters();
    
    // Elementos da barra de filtros
    const toggleFiltersBtn = document.getElementById('toggleFiltersBar');
    const filtersPanel = document.getElementById('filtersPanel');

    // Toggle do painel de filtros
    if (toggleFiltersBtn && filtersPanel) {
        toggleFiltersBtn.addEventListener('click', () => {
            filtersPanel.classList.toggle('hidden');
            toggleFiltersBtn.classList.toggle('expanded');
            
            // Atualizar ícone
            const icon = toggleFiltersBtn.querySelector('i');
            if (filtersPanel.classList.contains('hidden')) {
                icon.className = 'fas fa-sliders-h mr-2';
                toggleFiltersBtn.innerHTML = '<i class="fas fa-sliders-h mr-2"></i>Filtros e Gráficos';
            } else {
                icon.className = 'fas fa-times mr-2';
                toggleFiltersBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Fechar Filtros';
            }
        });
    }

    // Inicializar sistema de gráficos
    dashboardFilters.initializeChartToggles();
    dashboardFilters.loadChartPreferences();

    // Remover botão flutuante e modal antigos se existirem
    const floatingBtn = document.getElementById('openFiltersModalBtn');
    const oldModal = document.getElementById('filtersModal');
    if (floatingBtn) floatingBtn.remove();
    if (oldModal) oldModal.remove();
});

// ================================================================
// FUNÇÕES AUXILIARES
// ================================================================

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}


// ================================================================
// SISTEMA DE GRÁFICOS
// ================================================================

class DashboardCharts {
    constructor() {
        this.charts = {};
        this.data = {};
        this.initializeCharts();
    }

    initializeCharts() {
        try {
            // Parse dos dados do contexto Django
            const dadosJson = document.getElementById('dados-json');
            if (dadosJson) {
                this.data = JSON.parse(dadosJson.textContent);
            } else {
                console.error('Elemento com dados JSON não encontrado');
                return;
            }

            // Inicializar todos os gráficos
            this.initTransacoesMensais();
            this.initSaldoAcumulado();
            this.initSazonalidade();
            this.initProjecaoSaldo();
            this.initSaidasCategoria();
            this.initEntradasCategoria();
            this.initSaldoContas();
            this.initDespesasFixasVariaveis();
            this.initStatusPagamentos();
            this.initAlocacaoInvestimentos();
            this.initAnaliseComportamental();
            
            // Atualizar cards principais
            this.updateMainCards();
            this.updateReservaEmergencia();
            this.updateIndicadoresSaude();
            this.updateSimulacoes();
            this.updateAnaliseRiscos();
            this.updateUltimasTransacoes();

        } catch (error) {
            console.error('Erro ao inicializar gráficos:', error);
        }
    }

    // ================================================================
    // GRÁFICOS PRINCIPAIS
    // ================================================================

    initTransacoesMensais() {
        const ctx = document.getElementById('transacoesMensaisCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.meses_labels || [],
            datasets: [
                {
                    label: 'Receitas',
                    data: this.data.receitas_mensais_data || [],
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2,
                    borderRadius: 8,
                },
                {
                    label: 'Despesas',
                    data: this.data.despesas_mensais_data || [],
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    borderRadius: 8,
                }
            ]
        };

        this.charts.transacoesMensais = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Receitas vs Despesas Mensais'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initSaldoAcumulado() {
        const ctx = document.getElementById('saldoAcumuladoCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.meses_labels || [],
            datasets: [
                {
                    label: 'Saldo Acumulado',
                    data: this.data.saldo_acumulado_data || [],
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                }
            ]
        };

        this.charts.saldoAcumulado = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initSazonalidade() {
        const ctx = document.getElementById('sazonalidadeCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.sazonalidade_labels || [],
            datasets: [
                {
                    label: 'Resultado Mensal',
                    data: this.data.sazonalidade_values || [],
                    backgroundColor: this.data.sazonalidade_values?.map(value => 
                        value >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                    ),
                    borderColor: this.data.sazonalidade_values?.map(value => 
                        value >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'
                    ),
                    borderWidth: 2,
                    borderRadius: 6,
                }
            ]
        };

        this.charts.sazonalidade = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initProjecaoSaldo() {
        const ctx = document.getElementById('projecaoSaldoCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.projecao_labels || [],
            datasets: [
                {
                    label: 'Saldo Real',
                    data: this.data.projecao_saldo?.slice(0, this.data.meses_labels?.length) || [],
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                },
                {
                    label: 'Projeção',
                    data: this.data.projecao_saldo || [],
                    borderColor: 'rgba(168, 85, 247, 1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                }
            ]
        };

        this.charts.projecaoSaldo = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initSaidasCategoria() {
        const ctx = document.getElementById('saidasCategoriaCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.categorias_despesas_labels || [],
            datasets: [{
                data: this.data.categorias_despesas_data || [],
                backgroundColor: [
                    '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
                    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
                    '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef'
                ],
                borderWidth: 2
            }]
        };

        this.charts.saidasCategoria = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }

    initEntradasCategoria() {
        const ctx = document.getElementById('entradasCategoriaCanvas');
        if (!ctx) return;

        const fallbackElement = document.getElementById('entradasCategoriaFallback');
        
        if (!this.data.categorias_receitas_values || this.data.categorias_receitas_values.length === 0) {
            if (fallbackElement) fallbackElement.classList.remove('hidden');
            return;
        }

        if (fallbackElement) fallbackElement.classList.add('hidden');

        const data = {
            labels: this.data.categorias_receitas_labels || [],
            datasets: [{
                data: this.data.categorias_receitas_values || [],
                backgroundColor: [
                    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
                    '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef'
                ],
                borderWidth: 2
            }]
        };

        this.charts.entradasCategoria = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }

    initSaldoContas() {
        const ctx = document.getElementById('saldoContasCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.saldo_contas_labels || [],
            datasets: [{
                data: this.data.saldo_contas_values || [],
                backgroundColor: this.data.saldo_contas_values?.map(value => 
                    value >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                ),
                borderColor: this.data.saldo_contas_values?.map(value => 
                    value >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'
                ),
                borderWidth: 2,
                borderRadius: 8,
            }]
        };

        this.charts.saldoContas = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initDespesasFixasVariaveis() {
        const ctx = document.getElementById('despesasFixasVariaveisCanvas');
        if (!ctx) return;

        const data = {
            labels: ['Despesas Fixas', 'Despesas Variáveis'],
            datasets: [{
                data: [
                    parseFloat(this.data.despesas_fixas || 0),
                    parseFloat(this.data.despesas_variaveis || 0)
                ],
                backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                borderWidth: 2
            }]
        };

        this.charts.despesasFixasVariaveis = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }

    initStatusPagamentos() {
        const ctx = document.getElementById('statusPagamentosCanvas');
        if (!ctx) return;

        const data = {
            labels: ['Pagamentos Realizados', 'Pagamentos Pendentes'],
            datasets: [{
                data: [
                    parseFloat(this.data.pagos_total || 0),
                    parseFloat(this.data.pendentes_total || 0)
                ],
                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(251, 146, 60, 0.8)'],
                borderWidth: 2
            }]
        };

        this.charts.statusPagamentos = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }

    initAlocacaoInvestimentos() {
        const ctx = document.getElementById('alocacaoInvestimentosCanvas');
        if (!ctx) return;

        const data = {
            labels: this.data.otimizacao_investimentos?.alocacao_labels || ['Reserva', 'Renda Fixa', 'Renda Variável'],
            datasets: [{
                data: this.data.otimizacao_investimentos?.alocacao_values || [60, 30, 10],
                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                borderWidth: 2
            }]
        };

        this.charts.alocacaoInvestimentos = new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }

    // ================================================================
    // ANÁLISE COMPORTAMENTAL
    // ================================================================

    initAnaliseComportamental() {
        this.initGastosPorDia();
        this.initGastosPorHora();
        this.initCategoriasComportamento();
    }

    initGastosPorDia() {
        const ctx = document.getElementById('gastosPorDiaChart');
        if (!ctx) return;

        const gastosPorDia = this.data.analise_comportamental?.gastos_por_dia || {};
        const dias = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
        
        const data = {
            labels: dias,
            datasets: [{
                label: 'Gastos por Dia',
                data: dias.map(dia => gastosPorDia[dia] || 0),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                borderRadius: 6,
            }]
        };

        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initGastosPorHora() {
        const ctx = document.getElementById('gastosPorHoraChart');
        if (!ctx) return;

        const gastosPorHora = this.data.analise_comportamental?.gastos_por_hora_dia || {};
        const horas = Array.from({length: 24}, (_, i) => i.toString());
        
        const data = {
            labels: horas.map(h => h + 'h'),
            datasets: [{
                label: 'Gastos por Hora',
                data: horas.map(hora => gastosPorHora[hora] || 0),
                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
            }]
        };

        new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    initCategoriasComportamento() {
        const ctx = document.getElementById('categoriasComportamentoChart');
        if (!ctx) return;

        const categorias = this.data.analise_comportamental?.categorias_comportamento || {
            'Essenciais': 60,
            'Supérfluos': 30,
            'Investimentos': 10
        };

        const data = {
            labels: Object.keys(categorias),
            datasets: [{
                data: Object.values(categorias),
                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(251, 146, 60, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                borderWidth: 2
            }]
        };

        new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
    }

    // ================================================================
    // ATUALIZAÇÃO DOS COMPONENTES
    // ================================================================

    updateMainCards() {
        // Saldo Geral
        const saldoGeral = document.getElementById('saldoGeral');
        if (saldoGeral) {
            saldoGeral.textContent = formatCurrency(parseFloat(this.data.saldo_geral || 0));
        }

        // Entradas do Mês
        const entradasMes = document.getElementById('entradasMes');
        if (entradasMes) {
            entradasMes.textContent = formatCurrency(parseFloat(this.data.entradas_mes || 0));
        }

        // Saídas do Mês
        const saidasMes = document.getElementById('saidasMes');
        if (saidasMes) {
            saidasMes.textContent = formatCurrency(parseFloat(this.data.saidas_mes || 0));
        }

        // Variações
        const variacaoReceitas = document.getElementById('variacaoReceitas');
        if (variacaoReceitas) {
            const variacao = parseFloat(this.data.variacao_receitas || 0);
            variacaoReceitas.textContent = `${variacao >= 0 ? '+' : ''}${variacao.toFixed(1)}%`;
            variacaoReceitas.className = `font-medium mr-1 ${variacao >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }

        const variacaoDespesas = document.getElementById('variacaoDespesas');
        if (variacaoDespesas) {
            const variacao = parseFloat(this.data.variacao_despesas || 0);
            variacaoDespesas.textContent = `${variacao >= 0 ? '+' : ''}${variacao.toFixed(1)}%`;
            variacaoDespesas.className = `font-medium mr-1 ${variacao >= 0 ? 'text-red-600' : 'text-green-600'}`;
        }

        // Saldo Poupanças
        const saldoPoupancas = document.getElementById('saldoPoupancas');
        if (saldoPoupancas) {
            saldoPoupancas.textContent = formatCurrency(parseFloat(this.data.saldo_poupancas || 0));
        }
    }

    updateReservaEmergencia() {
        const despesaMensalMedia = parseFloat(this.data.despesa_mensal_media || 0);
        const saldoPoupancas = parseFloat(this.data.saldo_poupancas || 0);
        const mesesMeta = parseInt(this.data.meses_meta || 6);

        const reservaIdeal = despesaMensalMedia * mesesMeta;
        const diferenca = reservaIdeal - saldoPoupancas;
        const percentualAtingido = reservaIdeal > 0 ? (saldoPoupancas / reservaIdeal) * 100 : 0;

        // Atualizar elementos
        const reservaEmergenciaIdeal = document.getElementById('reservaEmergenciaIdeal');
        if (reservaEmergenciaIdeal) {
            reservaEmergenciaIdeal.textContent = formatCurrency(reservaIdeal);
        }

        const despesaMensalMediaEl = document.getElementById('despesaMensalMedia');
        if (despesaMensalMediaEl) {
            despesaMensalMediaEl.textContent = formatCurrency(despesaMensalMedia);
        }

        const saldoAtualPoupancas = document.getElementById('saldoAtualPoupancas');
        if (saldoAtualPoupancas) {
            saldoAtualPoupancas.textContent = formatCurrency(saldoPoupancas);
        }

        const valorFaltante = document.getElementById('valorFaltante');
        const diferencaLabel = document.getElementById('diferencaLabel');
        const diferencaReservaPanel = document.getElementById('diferencaReservaPanel');
        
        if (valorFaltante && diferencaLabel && diferencaReservaPanel) {
            if (diferenca > 0) {
                valorFaltante.textContent = formatCurrency(diferenca);
                diferencaLabel.textContent = 'Falta:';
                valorFaltante.className = 'text-lg font-bold text-orange-600';
                diferencaReservaPanel.className = 'mb-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg';
            } else {
                valorFaltante.textContent = formatCurrency(Math.abs(diferenca));
                diferencaLabel.textContent = 'Excedente:';
                valorFaltante.className = 'text-lg font-bold text-green-600';
                diferencaReservaPanel.className = 'mb-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg';
            }
        }

        const percentualAtingidoEl = document.getElementById('percentualAtingido');
        if (percentualAtingidoEl) {
            percentualAtingidoEl.textContent = `${Math.min(percentualAtingido, 100).toFixed(1)}%`;
        }

        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.style.width = `${Math.min(percentualAtingido, 100)}%`;
            progressBar.className = `h-2 rounded-full ${percentualAtingido >= 100 ? 'bg-green-500' : 'bg-blue-500'}`;
        }

        // Status
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const statusReservaPanel = document.getElementById('statusReservaPanel');
        
        if (statusIcon && statusText && statusReservaPanel) {
            if (percentualAtingido >= 100) {
                statusIcon.className = 'fas fa-check-circle text-green-500';
                statusText.textContent = 'Meta atingida!';
                statusReservaPanel.className = 'text-center p-2 rounded-lg bg-green-50 dark:bg-green-900/20';
            } else if (percentualAtingido >= 70) {
                statusIcon.className = 'fas fa-exclamation-circle text-yellow-500';
                statusText.textContent = `${percentualAtingido.toFixed(1)}% conquistado`;
                statusReservaPanel.className = 'text-center p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20';
            } else {
                statusIcon.className = 'fas fa-info-circle text-blue-500';
                statusText.textContent = `${percentualAtingido.toFixed(1)}% conquistado`;
                statusReservaPanel.className = 'text-center p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20';
            }
        }
    }

    updateIndicadoresSaude() {
        const indicadores = this.data.indicadores || {};
        
        const elements = {
            'liquidezCorrente': 'liquidez_corrente',
            'margemSeguranca': 'margem_seguranca',
            'endividamento': 'endividamento',
            'poupancaMensal': 'poupanca_mensal',
            'reservaEmergenciaIdealIndicador': 'reserva_emergencia_ideal'
        };

        Object.keys(elements).forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
                const value = indicadores[elements[elementId]] || 0;
                if (elementId === 'poupancaMensal' || elementId === 'reservaEmergenciaIdealIndicador') {
                    element.textContent = formatCurrency(value);
                } else {
                    element.textContent = `${value.toFixed(1)}%`;
                }
            }
        });

        const nivelRisco = document.getElementById('nivelRisco');
        if (nivelRisco) {
            const endividamento = indicadores.endividamento || 0;
            if (endividamento > 50) {
                nivelRisco.textContent = 'Alto';
                nivelRisco.className = 'text-3xl font-bold text-red-600';
            } else if (endividamento > 20) {
                nivelRisco.textContent = 'Moderado';
                nivelRisco.className = 'text-3xl font-bold text-yellow-600';
            } else {
                nivelRisco.textContent = 'Baixo';
                nivelRisco.className = 'text-3xl font-bold text-green-600';
            }
        }
    }

    updateSimulacoes() {
        const simulacoes = this.data.simulacoes || {};
        
        const elements = {
            'aumentoDespesas': 'aumento_10_despesas',
            'reducaoDespesas': 'reducao_10_despesas',
            'aumentoReceitas': 'aumento_10_receitas',
            'reducaoReceitas': 'reducao_10_receitas',
            'impactoInflacao': 'impacto_inflacao_5'
        };

        Object.keys(elements).forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = formatCurrency(simulacoes[elements[elementId]] || 0);
            }
        });
    }

    updateAnaliseRiscos() {
        const analiseRiscos = this.data.analise_riscos || {};
        
        const concentracaoRisco = document.getElementById('concentracaoRisco');
        if (concentracaoRisco) {
            concentracaoRisco.textContent = `${(analiseRiscos.concentracao_risco || 0).toFixed(1)}%`;
        }

        const reservaIdealCoberta = document.getElementById('reservaIdealCoberta');
        if (reservaIdealCoberta) {
            const saldoPoupancas = parseFloat(this.data.saldo_poupancas || 0);
            const reservaIdeal = analiseRiscos.reserva_ideal || 0;
            reservaIdealCoberta.textContent = `${formatCurrency(saldoPoupancas)} / ${formatCurrency(reservaIdeal)}`;
        }

        const nivelRiscoTexto = document.getElementById('nivelRiscoTexto');
        if (nivelRiscoTexto) {
            nivelRiscoTexto.textContent = analiseRiscos.nivel_risco || 'Baixo';
        }
    }

    updateUltimasTransacoes() {
        const tableBody = document.getElementById('ultimasTransacoesTable');
        if (!tableBody) return;

        const transacoes = this.data.ultimas_transacoes || [];
        
        if (transacoes.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                        Nenhuma transação encontrada
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = transacoes.map(transacao => `
            <tr class="table-row">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                    ${new Date(transacao.data).toLocaleDateString('pt-BR')}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-100">
                    ${transacao.descricao}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${transacao.valor >= 0 ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold'}">
                    ${formatCurrency(transacao.valor)}
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                    ${transacao.categoria}
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                    ${transacao.conta}
                </td>
            </tr>
        `).join('');
    }
}

// ================================================================
// INICIALIZAÇÃO
// ================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar sistema de gráficos
    window.dashboardCharts = new DashboardCharts();
    
    // Event listener para o seletor de meses da meta
    const mesesMetaSelect = document.getElementById('meses-meta-select');
    if (mesesMetaSelect) {
        mesesMetaSelect.addEventListener('change', function() {
            dashboardFilters.applyFilters();
        });
    }

    // Event listener para exportar relatório
    const exportReportBtn = document.getElementById('exportReportBtn');
    if (exportReportBtn) {
        exportReportBtn.addEventListener('click', function() {
            // Implementar lógica de exportação aqui
            showNotification('Funcionalidade de exportação em desenvolvimento', 'info');
        });
    }
});

// Função auxiliar para formatar moeda
function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}


</script>
{% endblock %}